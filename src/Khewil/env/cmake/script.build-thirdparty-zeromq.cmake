cmake_minimum_required(VERSION 2.8 FATAL_ERROR)

message(STATUS "CMAKE_CURRENT_LIST_DIR=${CMAKE_CURRENT_LIST_DIR}")
message(STATUS "CMAKE_MAKE_PROGRAM=${CMAKE_MAKE_PROGRAM}")
message(STATUS "KHEWIL_TOOL_CURL=${KHEWIL_TOOL_CURL}")
message(STATUS "KHEWIL_TOOL_ZIP=${KHEWIL_TOOL_ZIP}")
message(STATUS "KHEWIL_THIRDPARTIES_SRC_ZIP_DIR=${KHEWIL_THIRDPARTIES_SRC_ZIP_DIR}")
message(STATUS "KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR=${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}")
message(STATUS "KHEWIL_THIRDPARTIES_INSTALL_DIR=${KHEWIL_THIRDPARTIES_INSTALL_DIR}")
message(STATUS "KHEWIL_THIRDPARTIES_CACHE_DIR=${KHEWIL_THIRDPARTIES_CACHE_DIR}")
message(STATUS "KHEWIL_ZEROMQ_SRC_NAMEVERSION=${KHEWIL_ZEROMQ_SRC_NAMEVERSION}")
message(STATUS "KHEWIL_ZEROMQ_INSTALL_NAMEVERSION=${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}")

set(KHEWIL_ZEROMQ_INNERBUILD_DIR "${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}/builds/msvc/vs2013")
message(STATUS "KHEWIL_ZEROMQ_INNERBUILD_DIR=${KHEWIL_ZEROMQ_INNERBUILD_DIR}")

include("${CMAKE_CURRENT_LIST_DIR}/script.helpers.cmake")

function(khewil_zeromq_build)
	file(MAKE_DIRECTORY "${KHEWIL_ZEROMQ_INNERBUILD_DIR}")
	execute_process(
		COMMAND
			"${CMAKE_MAKE_PROGRAM}"
			"${KHEWIL_ZEROMQ_INNERBUILD_DIR}/libzmq/libzmq.vcxproj"
			-p:Configuration=ReleaseDLL
			-p:Platform=Win32
			-p:PlatformToolset=v120
			"-p:SolutionDir=${KHEWIL_ZEROMQ_INNERBUILD_DIR}/"
			-p:Option-sodium=false
			-p:Linkage-libsodium=
		WORKING_DIRECTORY "${KHEWIL_ZEROMQ_INNERBUILD_DIR}"
		)
	khewil_copy(
		"${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}/bin/Win32/Release/v120/dynamic"
		"${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}/lib"
		"*.lib"
		FALSE
		)
	khewil_copy(
		"${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}/bin/Win32/Release/v120/dynamic"
		"${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}/bin"
		"*.dll"
		FALSE
		)
	khewil_copy(
		"${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}/include"
		"${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}/inc/zeromq"
		"*.h"
		FALSE
		)
endfunction()

khewil_download_unzip(
	"http://download.zeromq.org/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}.zip"
	"${KHEWIL_THIRDPARTIES_SRC_ZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}.zip"
	"${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_ZEROMQ_SRC_NAMEVERSION}"
	)

khewil_zeromq_build()

khewil_zip_upload(
	"${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}"
	"${KHEWIL_THIRDPARTIES_CACHE_DIR}/${KHEWIL_ZEROMQ_INSTALL_NAMEVERSION}.zip"
	)
