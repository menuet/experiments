cmake_minimum_required(VERSION 2.8 FATAL_ERROR)
project(khewil-thirdparty-soci)

if("${KHEWIL_SOCI_BUILD_DIR}" STREQUAL "")
	set(KHEWIL_SOCI_BUILD_DIR "${CMAKE_CURRENT_BINARY_DIR}/build")
endif()
message(STATUS "KHEWIL_SOCI_BUILD_DIR=${KHEWIL_SOCI_BUILD_DIR}")
file(MAKE_DIRECTORY "${KHEWIL_SOCI_BUILD_DIR}")

if("${KHEWIL_SOCI_SOURCE_NAME}" STREQUAL "")
	set(KHEWIL_SOCI_SOURCE_NAME "soci-3.2.3")
endif()
message(STATUS "KHEWIL_SOCI_SOURCE_NAME=${KHEWIL_SOCI_SOURCE_NAME}")

if("${KHEWIL_SOCI_SOURCE_DIR}" STREQUAL "")
	set(KHEWIL_SOCI_SOURCE_DIR "${KHEWIL_THIRDPARTIES_SOURCE_DIR}/${KHEWIL_SOCI_SOURCE_NAME}")
endif()
message(STATUS "KHEWIL_SOCI_SOURCE_DIR=${KHEWIL_SOCI_SOURCE_DIR}")

if("${KHEWIL_SOCI_INSTALL_NAME}" STREQUAL "")
	set(KHEWIL_SOCI_INSTALL_NAME "soci-3.2.3")
endif()
message(STATUS "KHEWIL_SOCI_INSTALL_NAME=${KHEWIL_SOCI_INSTALL_NAME}")

if("${KHEWIL_SOCI_INSTALL_DIR}" STREQUAL "")
	set(KHEWIL_SOCI_INSTALL_DIR "${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_SOCI_INSTALL_NAME}")
endif()
message(STATUS "KHEWIL_SOCI_INSTALL_DIR=${KHEWIL_SOCI_INSTALL_DIR}")

add_custom_target(
	khewil-soci-build
	COMMAND ${CMAKE_COMMAND}
		-G "${CMAKE_GENERATOR}"
		-D "SQLITE_ROOT_DIR=${KHEWIL_SQLITE_INSTALL_DIR}"
		-D "SQLITE3_INCLUDE_DIR=${KHEWIL_SQLITE_INSTALL_DIR}/inc/sqlite"
		-D "SQLITE3_LIBRARIES=${KHEWIL_SQLITE_INSTALL_DIR}/lib"
		-D "BOOST_INCLUDE_DIR=${KHEWIL_BOOST_INSTALL_DIR}/inc"
		-D "BOOST_LIBRARIES=${KHEWIL_BOOST_INSTALL_DIR}/lib"
		"${KHEWIL_SOCI_SOURCE_DIR}"
	WORKING_DIRECTORY "${KHEWIL_SOCI_BUILD_DIR}"
	)

add_dependencies(khewil-soci-build khewil-boost-build khewil-sqlite-build)

add_custom_command(
	TARGET khewil-soci-build
	POST_BUILD
	COMMAND ${CMAKE_COMMAND} --build "${KHEWIL_SOCI_BUILD_DIR}" --config Release --target soci_core
	COMMAND ${CMAKE_COMMAND} --build "${KHEWIL_SOCI_BUILD_DIR}" --config Release --target soci_sqlite3
	WORKING_DIRECTORY "${KHEWIL_SOCI_BUILD_DIR}"
	)

add_custom_target(
	khewil-soci-install
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_SOCI_BUILD_DIR}/lib/Release" "-DKHEWIL_UTIL_SOURCE_FILTER=*.lib" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_SOCI_INSTALL_DIR}/lib" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_SOCI_BUILD_DIR}/bin/Release" "-DKHEWIL_UTIL_SOURCE_FILTER=*.dll" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_SOCI_INSTALL_DIR}/bin" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_SOCI_SOURCE_DIR}/core" "-DKHEWIL_UTIL_SOURCE_FILTER=*.h" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_SOCI_INSTALL_DIR}/inc/soci" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_SOCI_SOURCE_DIR}/backends/sqlite3" "-DKHEWIL_UTIL_SOURCE_FILTER=soci-sqlite3.h" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_SOCI_INSTALL_DIR}/inc/soci" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	)

add_dependencies(khewil-soci-install khewil-soci-build)
