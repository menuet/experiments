cmake_minimum_required(VERSION 2.8 FATAL_ERROR)
project(khewil-thirdparty-protobuf)

if("${KHEWIL_PROTOBUF_BUILD_DIR}" STREQUAL "")
	set(KHEWIL_PROTOBUF_BUILD_DIR "${CMAKE_CURRENT_BINARY_DIR}/inner-build")
endif()
message(STATUS "KHEWIL_PROTOBUF_BUILD_DIR=${KHEWIL_PROTOBUF_BUILD_DIR}")
file(MAKE_DIRECTORY "${KHEWIL_PROTOBUF_BUILD_DIR}")

if("${KHEWIL_PROTOBUF_SRC_NAMEVERSION}" STREQUAL "")
	set(KHEWIL_PROTOBUF_SRC_NAMEVERSION "protobuf-3.0.0-beta-1")
endif()
message(STATUS "KHEWIL_PROTOBUF_SRC_NAMEVERSION=${KHEWIL_PROTOBUF_SRC_NAMEVERSION}")

if("${KHEWIL_PROTOBUF_SRC_UNZIP_DIR}" STREQUAL "")
	set(KHEWIL_PROTOBUF_SRC_UNZIP_DIR "${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}/${KHEWIL_PROTOBUF_SRC_NAMEVERSION}")
endif()
message(STATUS "KHEWIL_PROTOBUF_SRC_UNZIP_DIR=${KHEWIL_PROTOBUF_SRC_UNZIP_DIR}")

if("${KHEWIL_PROTOBUF_SRC_ZIP_URL}" STREQUAL "")
	set(KHEWIL_PROTOBUF_SRC_ZIP_URL "https://github.com/google/protobuf/archive/v3.0.0-beta-1.zip")
endif()
message(STATUS "KHEWIL_PROTOBUF_SRC_ZIP_URL=${KHEWIL_PROTOBUF_SRC_ZIP_URL}")

if("${KHEWIL_PROTOBUF_INSTALL_NAMEVERSION}" STREQUAL "")
	set(KHEWIL_PROTOBUF_INSTALL_NAMEVERSION "protobuf-3.0.0-beta-1")
endif()
message(STATUS "KHEWIL_PROTOBUF_INSTALL_NAMEVERSION=${KHEWIL_PROTOBUF_INSTALL_NAMEVERSION}")

if("${KHEWIL_PROTOBUF_INSTALL_DIR}" STREQUAL "")
	set(KHEWIL_PROTOBUF_INSTALL_DIR "${KHEWIL_THIRDPARTIES_INSTALL_DIR}/${KHEWIL_PROTOBUF_INSTALL_NAMEVERSION}")
endif()
message(STATUS "KHEWIL_PROTOBUF_INSTALL_DIR=${KHEWIL_PROTOBUF_INSTALL_DIR}")

add_custom_target(
	khewil-protobuf-build-get
#	COMMAND "${CMAKE_COMMAND}" -E make_directory "${KHEWIL_THIRDPARTIES_SRC_ZIP_DIR}"
#	COMMAND
#		"${KHEWIL_TOOL_CURL}"
#		--location --retry 5 --retry-delay 15
#		--output "${KHEWIL_THIRDPARTIES_SRC_ZIP_DIR}/${KHEWIL_PROTOBUF_SRC_NAMEVERSION}.zip"
#		"${KHEWIL_PROTOBUF_SRC_ZIP_URL}"
	)

add_custom_target(
	khewil-protobuf-build-unzip
#	COMMAND "${CMAKE_COMMAND}" -E make_directory "${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}"
#	COMMAND
#		"${KHEWIL_TOOL_ZIP}"
#		x -y "-o${KHEWIL_THIRDPARTIES_SRC_UNZIP_DIR}"
#		"${KHEWIL_THIRDPARTIES_SRC_ZIP_DIR}/${KHEWIL_PROTOBUF_SRC_NAMEVERSION}.zip"
	)

add_dependencies(khewil-protobuf-build-unzip khewil-protobuf-build-get)

add_custom_target(
	khewil-protobuf-build-prepare
	COMMAND "${CMAKE_COMMAND}" -E make_directory "${KHEWIL_PROTOBUF_BUILD_DIR}"
	)

add_dependencies(khewil-protobuf-build-prepare khewil-protobuf-build-unzip)

add_custom_target(
	khewil-protobuf-build-build
	COMMAND ${CMAKE_COMMAND}
		-G "${CMAKE_GENERATOR}"
		-D "BUILD_TESTING=OFF"
		-D "BUILD_SHARED_LIBS=ON"
		"${KHEWIL_PROTOBUF_SRC_UNZIP_DIR}/cmake"
	WORKING_DIRECTORY "${KHEWIL_PROTOBUF_BUILD_DIR}"
	)

add_custom_command(
	TARGET khewil-protobuf-build-build
	POST_BUILD
	COMMAND ${CMAKE_COMMAND} --build "${KHEWIL_PROTOBUF_BUILD_DIR}" --config Release
	COMMAND "${KHEWIL_PROTOBUF_BUILD_DIR}/extract_includes.bat"
	WORKING_DIRECTORY "${KHEWIL_PROTOBUF_BUILD_DIR}"
	)

add_dependencies(khewil-protobuf-build-build khewil-protobuf-build-prepare)

add_custom_target(
	khewil-protobuf-build-install
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_PROTOBUF_BUILD_DIR}/Release" "-DKHEWIL_UTIL_SOURCE_FILTER=*.lib" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_PROTOBUF_INSTALL_DIR}/lib" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_PROTOBUF_BUILD_DIR}/Release" "-DKHEWIL_UTIL_SOURCE_FILTER=*.exe" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_PROTOBUF_INSTALL_DIR}/bin" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_PROTOBUF_BUILD_DIR}/Release" "-DKHEWIL_UTIL_SOURCE_FILTER=*.dll" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_PROTOBUF_INSTALL_DIR}/bin" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	COMMAND ${CMAKE_COMMAND} "-DKHEWIL_UTIL_METHOD=COPY_FILES" "-DKHEWIL_UTIL_SOURCE_DIR=${KHEWIL_PROTOBUF_BUILD_DIR}/include" "-DKHEWIL_UTIL_SOURCE_FILTER=*.*" "-DKHEWIL_UTIL_TARGET_DIR=${KHEWIL_PROTOBUF_INSTALL_DIR}/inc" "-DKHEWIL_UTIL_RECURSIVE=TRUE" -P "${KHEWIL_CMAKE_MODULES_DIR}/utils.cmake"
	)

add_dependencies(khewil-protobuf-build-install khewil-protobuf-build-build)

add_custom_target(
	khewil-protobuf-build-cache
	COMMAND "${KHEWIL_TOOL_ZIP}" a -r "${KHEWIL_THIRDPARTIES_CACHE_DIR}/${KHEWIL_PROTOBUF_INSTALL_NAMEVERSION}.zip" "${KHEWIL_PROTOBUF_INSTALL_DIR}/*"
	)

add_dependencies(khewil-protobuf-build-cache khewil-protobuf-build-install)

add_custom_target(
	khewil-protobuf-build
	)

add_dependencies(khewil-protobuf-build khewil-protobuf-build-cache)
